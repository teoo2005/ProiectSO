#!/bin/bash

while true; do
    # Solicitam numele de utilizator
    echo "Introduceti numele de utilizator pentru autentificare:"
    read user

    # Cautam utilizatorul in fisierul utilizatori.csv
    line=$(grep ",$user," utilizatori.csv)

    # Daca utilizatorul nu este gasit, afisam mesaj si cerem din nou numele
    if [ -z "$line" ]; then
        echo "Eroare: Utilizatorul $user nu exista inregistrat. Va rugam sa va inregistrati mai intai."
        echo "Mergeti in meniul principal la inregistrare."
        continue
    fi

    # Extragem parola criptata
    stored_password=$(echo "$line" | sed 's/^[^,]*,[^,]*,[^,]*,\([^,]*\).*$/\1/')

    # Solicitam parola
    echo "Introduceti parola:"
    read -s input_password

    # Criptam parola introdusa
    input_password_hash=$(echo -n "$input_password" | sha256sum | sed 's/^\([a-f0-9]\{64\}\)\s.*$/\1/')

    # Verificam daca hash-ul parolei este corect
    if [ "$input_password_hash" != "$stored_password" ]; then
        echo "Eroare: Parola introdusa nu este corecta. Asigurati-va ca respectati exact parola introdusa la inregistrare."
        continue
    fi

    # Daca parola este corecta, actualizam campul last_login
    date_now=$(date '+%Y-%m-%d %H:%M:%S')
    sed -i "s/^$user,[^,]*,[^,]*,[^,]*$/&,$date_now/" utilizatori.csv

    # Extragem user_id
    user_id=$(echo "$line" | cut -d',' -f1)

    echo "Autentificare reusita! Esti acum in directorul tau personal: /home/$user_id"
    cd "/home/$user_id"
    utilizatori_logati+=("$user")
    echo "Utilizatorul $user este acum autentificat si logat."
    echo "Scrie 'exit' pentru a iesi din acest director personal."
    echo "Scrie 'raport' pentru a iesi din acest director personal."
    echo " Daca folosesti orice alta comanda, trebuie folosit sudo . "

    # Mini-shell personalizat cu acceptarea oricaror comenzi
    while true; do
        echo -n "(HOME-$user_id) $ "
        read -r comanda

        case $comanda in
            "raport")
                # Generare raport pentru utilizatorul curent
                echo "Se genereaza raportul pentru utilizatorul $user..."
                num_files=$(find "/home/$user_id" -type f | wc -l)
                num_dirs=$(find "/home/$user_id" -type d | wc -l)
                total_size=$(du -sh "/home/$user_id" | sed 's/^\([^[:space:]]*\).*/\1/')

                # CreÄƒm raportul
                report_file="/home/$user_id/raport_utilizator.txt"
                echo "Raport pentru utilizatorul $user" > "$report_file"
                echo "Numar de fisiere: $num_files" >> "$report_file"
                echo "Numar de directoare: $num_dirs" >> "$report_file"
                echo "Dimensiune totala pe disc: $total_size" >> "$report_file"
                
                echo "Raportul a fost generat si salvat in: $report_file"
                ;;
            "exit")
                echo "Iesire din directorul personal..."
                break
                ;;
            *)
                # Executa orice alta comanda data in mini-shell
                eval "$comanda" 
                ;;
        esac
    done

    break
done

