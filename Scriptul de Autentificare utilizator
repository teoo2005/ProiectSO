#!/bin/bash

while true; do
    # Solicităm numele de utilizator
    echo "Introduceți numele de utilizator pentru autentificare:"
    read user

    # Căutăm utilizatorul în fișierul utilizatori.csv
    line=$(grep "^$user," utilizatori.csv)

    # Dacă utilizatorul nu este găsit, afișăm mesaj detaliat și cerem din nou numele
    if [ -z "$line" ]; then
        echo "Eroare: Utilizatorul $user nu există înregistrat. Vă rugăm să vă înregistrați mai întâi."
        echo "Vă rugam mergeti in meniul principal la "inregistrare" " 
          exit 1 
    fi

    # Extragem parola criptată
    stored_password=$(echo $line | sed 's/^[^,]*,[^,]*,[^,]*,\([^,]*\),.*$/\1/')

    # Solicităm parola
    echo "Introduceți parola:"
    read -s input_password

    # Criptăm parola introdusă
    input_password_hash=$(echo -n "$input_password" | sha256sum | sed 's/^\([a-f0-9]\{64\}\)\s.*$/\1/')

    # Verificăm dacă hash-ul parolei este corect
    if [ "$input_password_hash" != "$stored_password" ]; then
        echo "Eroare: Parola introdusă nu este corectă. Parola trebuie să fie exact aceeași ca și cea înregistrată în sistem."
        echo "Asigurați-vă că respectați și majusculele/minusculele."
        continue
    fi

    # Dacă parola este corectă, actualizăm câmpul last_login
    date_now=$(date '+%Y-%m-%d %H:%M:%S')
    sed -i "s/^$user,[^,]*,[^,]*,[^,]*$/&,$date_now/" utilizatori.csv

    # Extragem user_id
    user_id=$(echo $line | sed 's/^\([^,]*\),.*$/\1/')

    # Creăm directorul home pentru utilizator
    mkdir -p "/home/$user_id"
    echo "Autentificare reușită! Vă veți îndrepta acum către directorul home al utilizatorului $user."
    echo "Acesta este directorul personal unde puteți salva fișierele sau face modificări."
    cd "/home/$user_id"

# Adăugăm utilizatorul la lista de utilizatori autentificați
    logged_in_users+=("$user")
    echo "Utilizatorul $user este acum autentificat."

    # Iesim din bucla while dacă autentificarea a avut succes
    break
done
