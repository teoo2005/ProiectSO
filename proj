#!/bin/bash

# Verificăm dacă fișierul utilizatori.csv există deja sau trebuie să-l creăm
if [ ! -f "utilizatori.csv" ]; then
    # Dacă fișierul nu există, îl creăm
    touch utilizatori.csv
    echo "Fișierul utilizatori.csv a fost creat." # Informăm utilizatorul
fi

while true; do
    # Solicităm numele de utilizator
    echo "Introduceti numele de utilizator:"
    read username

    # Verificăm dacă utilizatorul există deja în fișierul utilizatori.csv
    grep -q "^$username," utilizatori.csv

    if [ $? -eq 0 ]; then
        # Dacă utilizatorul există deja, afișăm un mesaj și cerem din nou numele
        echo "Utilizatorul $username exista deja. Va rugam sa alegeti un alt nume de utilizator."
        continue
    fi

    # Solicităm adresa de email
    echo "Introduceti adresa de email:"
    read email

    # Verificăm dacă email-ul există deja în fișierul CSV
    grep -q "^$email," utilizatori.csv
    if [ $? -eq 0 ]; then
        # Mesaj de feedback personalizat pentru email deja înregistrat
        echo "Adresa de email $email este deja înregistrată. Vă rugăm să alegeți un alt email."
        continue
    fi

    # Validăm adresa de email folosind un regex simplu
    echo "$email" | grep -E -q "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$"
    if [ $? -ne 0 ]; then
        # Mesaj de feedback personalizat pentru email invalid
        echo "Adresa de email introdusă nu este validă. Vă rugăm să introduceți un email valid (ex: exemplu@domeniu.com)."
        continue
    fi

    # Solicităm parola
    echo "Introduceti parola (minim 8 caractere, cel puțin o cifră):"
    read -s password

    # Validăm complexitatea parolei (minim 8 caractere și cel puțin o cifră)
    if [ ${#password} -lt 8 ] || [[ ! "$password" =~ [0-9] ]]; then
        echo "Parola trebuie sa aiba cel putin 8 caractere și sa contina cel putin o cifra."
        continue
    fi

    # Criptăm parola folosind sha256sum
    password_hash=$(echo -n "$password" | sha256sum | awk '{print $1}')

    # Descompunem calculul ID-ului utilizatorului
    line_count=$(wc -l < utilizatori.csv)   # numărul de linii din fișier
    user_id=$((line_count + 1))             # adăugăm 1 pentru a obține ID-ul

    # Creăm directorul home pentru utilizator, folosind ID-ul
    mkdir -p "/home/$user_id"
    echo "Directorul home pentru utilizatorul $username a fost creat la /home/$user_id."

    # Adăugăm utilizatorul în fișierul utilizatori.csv
    echo "$user_id,$username,$email,$password_hash" >> utilizatori.csv
    echo "Utilizatorul $username a fost adăugat în fișierul utilizatori.csv."

    # Confirmăm înregistrarea
    echo "Inregistrarea a fost realizata cu succes!"
    echo "ID Utilizator: $user_id"
    echo "Nume Utilizator: $username"
    echo "Email: $email"
    echo "Parola criptata: $password_hash"

    # Ieșim din bucla while, deoarece totul a fost completat corect
    break
done  
